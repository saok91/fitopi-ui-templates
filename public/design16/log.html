<!-- Design 16: Teal Wellness - log.html -->
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>فیتوپی - ثبت</title>
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="page-header">
      <h1 class="page-title">ثبت اطلاعات</h1>
      <p class="page-subtitle">کالری، فعالیت یا وزن خود را ثبت کنید</p>
    </header>

    <!-- Main Content -->
    <main class="main">
      <!-- Tabs -->
      <div class="tabs">
        <button type="button" class="tab active" data-tab="calorie">کالری</button>
        <button type="button" class="tab" data-tab="activity">فعالیت</button>
        <button type="button" class="tab" data-tab="weight">وزن</button>
      </div>

      <!-- Calorie Tab -->
      <div class="tab-content active" id="calorie">
        <div class="input-card">
          <h3 class="card-title">ثبت کالری</h3>
          <div class="log-date-row">
            <span class="log-date-label">ثبت برای</span>
            <div class="log-date-wrap">
              <button type="button" class="log-date-quick-btn active" id="calorie-today-btn" data-offset="0">امروز</button>
              <input type="date" id="calorie-log-date" class="log-date-input" aria-label="تاریخ ثبت کالری">
            </div>
          </div>
          <div class="calorie-input-row">
            <label for="calorie-text" class="visually-hidden">توضیح غذا</label>
            <textarea id="calorie-text" class="text-input calorie-text" placeholder="مثال: یک بشقاب قرمه‌سبزی با دو قاشق برنج"></textarea>
            <input type="file" id="calorie-photo-input" class="visually-hidden" accept="image/*" aria-label="انتخاب عکس غذا">
            <button type="button" class="attach-photo-btn" id="attach-photo-btn" aria-label="ارسال عکس غذا" title="ارسال عکس">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
            </button>
          </div>
          <!-- پیش‌نمایش عکس آپلود شده + حذف / تعویض -->
          <div class="photo-preview" id="photo-preview" hidden>
            <div class="photo-preview-inner">
              <img class="photo-preview-img" id="photo-preview-img" src="" alt="پیش‌نمایش عکس غذا">
              <div class="photo-preview-actions">
                <button type="button" class="photo-preview-btn change-photo-btn" id="change-photo-btn" aria-label="تعویض عکس" title="تعویض عکس">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                  <span>تعویض</span>
                </button>
                <button type="button" class="photo-preview-btn remove-photo-btn" id="remove-photo-btn" aria-label="حذف عکس" title="حذف عکس">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                  <span>حذف</span>
                </button>
              </div>
            </div>
          </div>
          <button class="submit-btn">ثبت کالری</button>
        </div>

        <div class="history-card">
          <h3 class="card-title">ثبت‌های اخیر</h3>
          <div class="history-list" id="calorie-history-list">
            <div class="history-item" data-edit-type="calorie" data-title="صبحانه: نان و پنیر" data-date="2025-02-09" data-value="320">
              <div class="item-info">
                <span class="item-title">صبحانه: نان و پنیر</span>
                <span class="item-time">امروز ۸:۳۰</span>
              </div>
              <div class="item-actions">
                <span class="item-value">۳۲۰ کالری</span>
                <div class="action-btns">
                  <button type="button" class="action-btn edit" aria-label="ویرایش"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                  <button type="button" class="action-btn delete" aria-label="حذف"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
                </div>
              </div>
            </div>
            <div class="history-item" data-edit-type="calorie" data-title="ناهار: پاستا با سس گوجه" data-date="2025-02-09" data-value="450">
              <div class="item-info">
                <span class="item-title">ناهار: پاستا با سس گوجه</span>
                <span class="item-time">امروز ۱۳:۱۵</span>
              </div>
              <div class="item-actions">
                <span class="item-value">۴۵۰ کالری</span>
                <div class="action-btns">
                  <button type="button" class="action-btn edit" aria-label="ویرایش"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                  <button type="button" class="action-btn delete" aria-label="حذف"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
                </div>
              </div>
            </div>
            <div class="history-item" data-edit-type="calorie" data-title="میان‌وعده: سیب" data-date="2025-02-09" data-value="70">
              <div class="item-info">
                <span class="item-title">میان‌وعده: سیب</span>
                <span class="item-time">امروز ۱۶:۰۰</span>
              </div>
              <div class="item-actions">
                <span class="item-value">۷۰ کالری</span>
                <div class="action-btns">
                  <button type="button" class="action-btn edit" aria-label="ویرایش"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                  <button type="button" class="action-btn delete" aria-label="حذف"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Activity Tab -->
      <div class="tab-content" id="activity">
        <div class="input-card">
          <h3 class="card-title">ثبت فعالیت</h3>
          <div class="log-date-row">
            <span class="log-date-label">ثبت برای</span>
            <div class="log-date-wrap">
              <button type="button" class="log-date-quick-btn active" id="activity-today-btn" data-offset="0">امروز</button>
              <input type="date" id="activity-log-date" class="log-date-input" aria-label="تاریخ ثبت فعالیت">
            </div>
          </div>
          <div class="activity-input-row">
            <label for="activity-text" class="visually-hidden">توضیح فعالیت</label>
            <textarea id="activity-text" class="text-input activity-text" placeholder="مثال: ۳۰ دقیقه پیاده‌روی تند در پارک"></textarea>
          </div>
          <button class="submit-btn">ثبت فعالیت</button>
        </div>

        <div class="history-card">
          <h3 class="card-title">فعالیت‌های اخیر</h3>
          <div class="history-list" id="activity-history-list">
            <div class="history-item" data-edit-type="activity" data-title="پیاده‌روی ۳۰ دقیقه" data-date="2025-02-08" data-value="150">
              <div class="item-info">
                <span class="item-title">پیاده‌روی ۳۰ دقیقه</span>
                <span class="item-time">دیروز ۱۸:۰۰</span>
              </div>
              <div class="item-actions">
                <span class="item-value activity">−۱۵۰ کالری</span>
                <div class="action-btns">
                  <button type="button" class="action-btn edit" aria-label="ویرایش"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                  <button type="button" class="action-btn delete" aria-label="حذف"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
                </div>
              </div>
            </div>
            <div class="history-item" data-edit-type="activity" data-title="یوگا ۴۵ دقیقه" data-date="2025-02-08" data-value="120">
              <div class="item-info">
                <span class="item-title">یوگا ۴۵ دقیقه</span>
                <span class="item-time">دیروز ۷:۰۰</span>
              </div>
              <div class="item-actions">
                <span class="item-value activity">−۱۲۰ کالری</span>
                <div class="action-btns">
                  <button type="button" class="action-btn edit" aria-label="ویرایش"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                  <button type="button" class="action-btn delete" aria-label="حذف"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Weight Tab -->
      <div class="tab-content" id="weight">
        <div class="input-card">
          <h3 class="card-title">ثبت وزن</h3>
          <div class="log-date-row">
            <span class="log-date-label">ثبت برای</span>
            <div class="log-date-wrap">
              <button type="button" class="log-date-quick-btn active" id="weight-today-btn" data-offset="0">امروز</button>
              <input type="date" id="weight-log-date" class="log-date-input" aria-label="تاریخ ثبت وزن">
            </div>
          </div>
          <div class="weight-input-row">
            <label for="weight-input" class="visually-hidden">وزن به کیلوگرم</label>
            <input type="number" id="weight-input" class="weight-input" placeholder="۷۲.۵" step="0.1">
            <span class="weight-unit-label">کیلوگرم</span>
          </div>
          <button class="submit-btn">ثبت وزن</button>
        </div>

        <div class="history-card">
          <h3 class="card-title">سوابق وزن</h3>
          <div class="history-list" id="weight-history-list">
            <div class="history-item" data-edit-type="weight" data-title="ثبت وزن" data-date="2025-02-09" data-value="73.3">
              <div class="item-info">
                <span class="item-title">ثبت وزن</span>
                <span class="item-time">امروز ۷:۰۰</span>
              </div>
              <div class="item-actions">
                <span class="item-value">۷۳.۳ کیلوگرم</span>
                <div class="action-btns">
                  <button type="button" class="action-btn edit" aria-label="ویرایش"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                  <button type="button" class="action-btn delete" aria-label="حذف"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
                </div>
              </div>
            </div>
            <div class="history-item" data-edit-type="weight" data-title="ثبت وزن" data-date="2025-02-02" data-value="74.5">
              <div class="item-info">
                <span class="item-title">ثبت وزن</span>
                <span class="item-time">هفته گذشته</span>
              </div>
              <div class="item-actions">
                <span class="item-value">۷۴.۵ کیلوگرم</span>
                <div class="action-btns">
                  <button type="button" class="action-btn edit" aria-label="ویرایش"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                  <button type="button" class="action-btn delete" aria-label="حذف"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Edit Modal -->
    <div class="edit-modal-overlay" id="edit-modal-overlay" aria-hidden="true" hidden>
      <div class="edit-modal" id="edit-modal" role="dialog" aria-labelledby="edit-modal-title" aria-modal="true">
        <div class="edit-modal-header">
          <h2 class="edit-modal-title" id="edit-modal-title">ویرایش ثبت</h2>
          <button type="button" class="edit-modal-close" id="edit-modal-close" aria-label="بستن">×</button>
        </div>
        <div class="edit-modal-body">
          <!-- ویرایش کالری -->
          <div class="edit-form-panel" id="edit-panel-calorie" data-panel="calorie" hidden>
            <div class="log-date-row">
              <span class="log-date-label">تاریخ</span>
              <div class="log-date-wrap">
                <input type="date" id="edit-calorie-date" class="log-date-input" aria-label="تاریخ">
              </div>
            </div>
            <label for="edit-calorie-title" class="visually-hidden">توضیح غذا</label>
            <textarea id="edit-calorie-title" class="text-input edit-calorie-text" placeholder="توضیح غذا" rows="2"></textarea>
            <div class="weight-input-wrapper">
              <label for="edit-calorie-value" class="visually-hidden">مقدار کالری</label>
              <input type="number" id="edit-calorie-value" class="weight-input edit-number" placeholder="۳۲۰" min="0" step="1">
              <span class="weight-unit-label">کالری</span>
            </div>
          </div>
          <!-- ویرایش فعالیت -->
          <div class="edit-form-panel" id="edit-panel-activity" data-panel="activity" hidden>
            <div class="log-date-row">
              <span class="log-date-label">تاریخ</span>
              <div class="log-date-wrap">
                <input type="date" id="edit-activity-date" class="log-date-input" aria-label="تاریخ">
              </div>
            </div>
            <label for="edit-activity-title" class="visually-hidden">توضیح فعالیت</label>
            <textarea id="edit-activity-title" class="text-input" placeholder="توضیح فعالیت" rows="2"></textarea>
            <div class="weight-input-wrapper">
              <label for="edit-activity-value" class="visually-hidden">کالری سوخته‌شده</label>
              <input type="number" id="edit-activity-value" class="weight-input edit-number" placeholder="۱۵۰" min="0" step="1">
              <span class="weight-unit-label">کالری سوخته‌شده</span>
            </div>
          </div>
          <!-- ویرایش وزن -->
          <div class="edit-form-panel" id="edit-panel-weight" data-panel="weight" hidden>
            <div class="log-date-row">
              <span class="log-date-label">تاریخ</span>
              <div class="log-date-wrap">
                <input type="date" id="edit-weight-date" class="log-date-input" aria-label="تاریخ">
              </div>
            </div>
            <div class="weight-input-wrapper">
              <label for="edit-weight-value" class="visually-hidden">وزن</label>
              <input type="number" id="edit-weight-value" class="weight-input" placeholder="۷۳.۳" step="0.1">
              <span class="weight-unit-label">کیلوگرم</span>
            </div>
          </div>
        </div>
        <div class="edit-modal-footer">
          <button type="button" class="edit-modal-cancel" id="edit-modal-cancel">انصراف</button>
          <button type="button" class="submit-btn edit-modal-save" id="edit-modal-save">ذخیره تغییرات</button>
        </div>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
      <a href="index.html" class="nav-item">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          <polyline points="9 22 9 12 15 12 15 22"/>
        </svg>
        <span>خانه</span>
      </a>
      <a href="log.html" class="nav-item active">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12h14"/>
        </svg>
        <span>ثبت</span>
      </a>
      <a href="chat.html" class="nav-item">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <span>گفتگو</span>
      </a>
    </nav>
  </div>

  <script>
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

    // عکس غذا: انتخاب، پیش‌نمایش، حذف، تعویض
    (function () {
      var input = document.getElementById('calorie-photo-input');
      var previewEl = document.getElementById('photo-preview');
      var previewImg = document.getElementById('photo-preview-img');
      var attachBtn = document.getElementById('attach-photo-btn');
      var changeBtn = document.getElementById('change-photo-btn');
      var removeBtn = document.getElementById('remove-photo-btn');

      function showPreview(url) {
        previewImg.src = url;
        previewEl.hidden = false;
      }
      function clearPreview() {
        previewImg.src = '';
        previewEl.hidden = true;
        if (input) input.value = '';
      }

      if (attachBtn && input) {
        attachBtn.addEventListener('click', function () { input.click(); });
      }
      if (input) {
        input.addEventListener('change', function () {
          var file = this.files && this.files[0];
          if (!file || !file.type.startsWith('image/')) return;
          var reader = new FileReader();
          reader.onload = function () { showPreview(reader.result); };
          reader.readAsDataURL(file);
        });
      }
      if (changeBtn && input) {
        changeBtn.addEventListener('click', function () { input.click(); });
      }
      if (removeBtn) {
        removeBtn.addEventListener('click', clearPreview);
      }
    })();

    // روز انتخاب برای ثبت (کالری / فعالیت / وزن): ثبت برای [امروز] [daypicker]
    (function () {
      var today = new Date();
      today.setHours(0, 0, 0, 0);

      function toYYYYMMDD(d) {
        var y = d.getFullYear();
        var m = (d.getMonth() + 1);
        var day = d.getDate();
        return y + '-' + (m < 10 ? '0' + m : m) + '-' + (day < 10 ? '0' + day : day);
      }
      function parseYYYYMMDD(s) {
        if (!s) return null;
        var parts = s.split('-').map(Number);
        if (parts.length !== 3) return null;
        var d = new Date(parts[0], parts[1] - 1, parts[2]);
        return isNaN(d.getTime()) ? null : d;
      }
      function isToday(dateStr) {
        var d = parseYYYYMMDD(dateStr);
        if (!d) return false;
        d.setHours(0, 0, 0, 0);
        return d.getTime() === today.getTime();
      }
      function updateDateInputState(input, todayBtn) {
        var todaySelected = isToday(input.value);
        if (todayBtn) todayBtn.classList.toggle('active', todaySelected);
        input.classList.toggle('selected', !todaySelected);
      }
      function setupDayPicker(inputId, todayBtnId) {
        var input = document.getElementById(inputId);
        var todayBtn = document.getElementById(todayBtnId);
        if (!input) return;
        input.setAttribute('max', toYYYYMMDD(today));
        input.value = toYYYYMMDD(today);
        if (todayBtn) todayBtn.classList.add('active');
        input.addEventListener('change', function () {
          updateDateInputState(input, todayBtn);
        });
        if (todayBtn) {
          todayBtn.addEventListener('click', function () {
            input.value = toYYYYMMDD(today);
            input.classList.remove('selected');
            if (todayBtn) todayBtn.classList.add('active');
          });
        }
      }
      setupDayPicker('calorie-log-date', 'calorie-today-btn');
      setupDayPicker('activity-log-date', 'activity-today-btn');
      setupDayPicker('weight-log-date', 'weight-today-btn');
    })();

    // textarea کالری: ارتفاع 44px تا وقتی متن به خط دوم نرفته؛ تا ۳ خط رشد؛ بعد اسکرول
    (function () {
      var ta = document.getElementById('calorie-text');
      if (!ta) return;
      var style = getComputedStyle(ta);
      var lineHeight = parseFloat(style.lineHeight) || parseFloat(style.fontSize) * 1.4;
      var paddingTop = parseFloat(style.paddingTop) || 10;
      var paddingBottom = parseFloat(style.paddingBottom) || 10;
      var oneLineHeight = 44;
      var maxHeight = Math.ceil(lineHeight * 3 + paddingTop + paddingBottom);

      function resize() {
        ta.style.height = oneLineHeight + 'px';
        var sh = ta.scrollHeight;
        if (sh <= oneLineHeight) {
          ta.style.overflowY = 'hidden';
          return;
        }
        ta.style.height = 'auto';
        sh = ta.scrollHeight;
        if (sh <= maxHeight) {
          ta.style.height = sh + 'px';
          ta.style.overflowY = 'hidden';
        } else {
          ta.style.height = maxHeight + 'px';
          ta.style.overflowY = 'auto';
        }
      }
      ta.addEventListener('input', resize);
    })();

    // textarea فعالیت: همان رفتار — یک خط پیش‌فرض، تا ۳ خط رشد، بعد اسکرول
    (function () {
      var ta = document.getElementById('activity-text');
      if (!ta) return;
      var style = getComputedStyle(ta);
      var lineHeight = parseFloat(style.lineHeight) || parseFloat(style.fontSize) * 1.4;
      var paddingTop = parseFloat(style.paddingTop) || 10;
      var paddingBottom = parseFloat(style.paddingBottom) || 10;
      var oneLineHeight = 44;
      var maxHeight = Math.ceil(lineHeight * 3 + paddingTop + paddingBottom);

      function resize() {
        ta.style.height = oneLineHeight + 'px';
        var sh = ta.scrollHeight;
        if (sh <= oneLineHeight) {
          ta.style.overflowY = 'hidden';
          return;
        }
        ta.style.height = 'auto';
        sh = ta.scrollHeight;
        if (sh <= maxHeight) {
          ta.style.height = sh + 'px';
          ta.style.overflowY = 'hidden';
        } else {
          ta.style.height = maxHeight + 'px';
          ta.style.overflowY = 'auto';
        }
      }
      ta.addEventListener('input', resize);
    })();

    // ویرایش آیتم از لیست (کالری / فعالیت / وزن)
    (function () {
      var overlay = document.getElementById('edit-modal-overlay');
      var modal = document.getElementById('edit-modal');
      var closeBtn = document.getElementById('edit-modal-close');
      var cancelBtn = document.getElementById('edit-modal-cancel');
      var saveBtn = document.getElementById('edit-modal-save');
      var titleEl = document.getElementById('edit-modal-title');
      var panels = {
        calorie: document.getElementById('edit-panel-calorie'),
        activity: document.getElementById('edit-panel-activity'),
        weight: document.getElementById('edit-panel-weight')
      };
      var editCalorieDate = document.getElementById('edit-calorie-date');
      var editCalorieTitle = document.getElementById('edit-calorie-title');
      var editCalorieValue = document.getElementById('edit-calorie-value');
      var editActivityDate = document.getElementById('edit-activity-date');
      var editActivityTitle = document.getElementById('edit-activity-title');
      var editActivityValue = document.getElementById('edit-activity-value');
      var editWeightDate = document.getElementById('edit-weight-date');
      var editWeightValue = document.getElementById('edit-weight-value');

      var currentItem = null;
      var today = new Date();
      today.setHours(0, 0, 0, 0);
      function toYYYYMMDD(d) {
        var y = d.getFullYear();
        var m = (d.getMonth() + 1);
        var day = d.getDate();
        return y + '-' + (m < 10 ? '0' + m : m) + '-' + (day < 10 ? '0' + day : day);
      }

      function openEditModal(item) {
        currentItem = item;
        var type = item.getAttribute('data-edit-type');
        var title = item.getAttribute('data-title') || '';
        var date = item.getAttribute('data-date') || toYYYYMMDD(today);
        var value = item.getAttribute('data-value') || '';

        Object.keys(panels).forEach(function (k) {
          panels[k].hidden = (k !== type);
        });

        if (type === 'calorie') {
          titleEl.textContent = 'ویرایش کالری';
          editCalorieDate.value = date;
          editCalorieTitle.value = title;
          editCalorieValue.value = value;
        } else if (type === 'activity') {
          titleEl.textContent = 'ویرایش فعالیت';
          editActivityDate.value = date;
          editActivityTitle.value = title;
          editActivityValue.value = value;
        } else if (type === 'weight') {
          titleEl.textContent = 'ویرایش وزن';
          editWeightDate.value = date;
          editWeightValue.value = value;
        }

        overlay.hidden = false;
        overlay.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        (type === 'calorie' ? editCalorieTitle : type === 'activity' ? editActivityTitle : editWeightValue).focus();
      }

      function closeEditModal() {
        overlay.hidden = true;
        overlay.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        currentItem = null;
      }

      function formatTimeLabel(dateStr) {
        var parts = dateStr.split('-').map(Number);
        if (parts.length !== 3) return dateStr;
        var d = new Date(parts[0], parts[1] - 1, parts[2]);
        if (isNaN(d.getTime())) return dateStr;
        var todayStr = toYYYYMMDD(today);
        if (dateStr === todayStr) return 'امروز';
        var yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        if (dateStr === toYYYYMMDD(yesterday)) return 'دیروز';
        return d.toLocaleDateString('fa-IR', { month: 'short', day: 'numeric', year: 'numeric' });
      }

      function saveEdit() {
        if (!currentItem) return;
        var type = currentItem.getAttribute('data-edit-type');
        var newDate, newTitle, newValue;

        if (type === 'calorie') {
          newDate = editCalorieDate.value;
          newTitle = editCalorieTitle.value.trim() || 'بدون عنوان';
          newValue = editCalorieValue.value.trim() || '0';
          currentItem.setAttribute('data-date', newDate);
          currentItem.setAttribute('data-title', newTitle);
          currentItem.setAttribute('data-value', newValue);
          currentItem.querySelector('.item-title').textContent = newTitle;
          currentItem.querySelector('.item-time').textContent = formatTimeLabel(newDate);
          currentItem.querySelector('.item-value').textContent = newValue + ' کالری';
        } else if (type === 'activity') {
          newDate = editActivityDate.value;
          newTitle = editActivityTitle.value.trim() || 'بدون عنوان';
          newValue = editActivityValue.value.trim() || '0';
          currentItem.setAttribute('data-date', newDate);
          currentItem.setAttribute('data-title', newTitle);
          currentItem.setAttribute('data-value', newValue);
          currentItem.querySelector('.item-title').textContent = newTitle;
          currentItem.querySelector('.item-time').textContent = formatTimeLabel(newDate);
          currentItem.querySelector('.item-value').textContent = '−' + newValue + ' کالری';
        } else if (type === 'weight') {
          newDate = editWeightDate.value;
          newValue = editWeightValue.value.trim() || '0';
          currentItem.setAttribute('data-date', newDate);
          currentItem.setAttribute('data-value', newValue);
          currentItem.querySelector('.item-time').textContent = formatTimeLabel(newDate);
          currentItem.querySelector('.item-value').textContent = newValue + ' کیلوگرم';
        }

        closeEditModal();
      }

      document.querySelectorAll('.history-item .action-btn.edit').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var item = btn.closest('.history-item');
          if (item && item.getAttribute('data-edit-type')) openEditModal(item);
        });
      });

      if (closeBtn) closeBtn.addEventListener('click', closeEditModal);
      if (cancelBtn) cancelBtn.addEventListener('click', closeEditModal);
      if (saveBtn) saveBtn.addEventListener('click', saveEdit);
      if (overlay) {
        overlay.addEventListener('click', function (e) {
          if (e.target === overlay) closeEditModal();
        });
      }
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && overlay && !overlay.hidden) closeEditModal();
      });
    })();
  </script>
</body>
</html>
